---
title: 'Learning Lab 1 Guided Practice'
author: "Dr. Joshua Kellogg"
date: "`r format(Sys.Date(),'%B %e, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    toc_float: yes
    code_folding: show
    code_download: TRUE
editor_options:
  markdown:
    wrap: 72
bibliography: lit/references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## step 0: prep

```{r}
library(tidyverse)
library(here)
library(tidymodels)
library(vip)
library(ranger)

d <- read_rds(here("data", "ngsschat-data.rds"))

codes <- read_csv(here("data", "ngsschat-qualitative-codes.csv"))

codes <- codes %>% 
    select(id_string = ID, code = Code)

dd <- d %>% 
    left_join(codes) %>% 
    filter(!is.na(code)) %>% 
    filter(code != "OT" & code != "RT" & code != "TF")

ddd <- dd %>% 
    select(favorite_count, retweet_count, followers_count, friends_count, statuses_count, display_text_width, 
           # screen_name, text,
           # created_at, account_created_at,
           code, id_string) %>% 
    filter(!is.na(favorite_count)) %>% 
    group_by(id_string)

ddd <- ddd %>% 
    summarize(mean_favorite_count = mean(favorite_count),
              mean_retweet_count = mean(retweet_count),
              mean_status_count = mean(statuses_count),
              mean_followers_count = mean(followers_count),
              mean_friends_count = mean(friends_count),
              sum_display_text_width = sum(display_text_width),
              n = n()) %>% 
    left_join(distinct(dd, id_string, code))

ddd %>% write_csv("ngsschat-data-joined.csv")
```

## step 1: split 

```{r}
train_test_split <- initial_split(ddd, prop = .70)

data_train <- training(train_test_split)
data_test <- testing(train_test_split)
```

## step 2: pre-processing/feature engineering

```{r}
my_rec <- recipe(code ~ ., data = ddd) %>% 
    add_role(id_string, new_role = "id") %>% 
    step_normalize(all_numeric_predictors()) %>%
    step_nzv(all_predictors())
```

## 3: set up the model, workflow, and tuning grid

```{r}
# specify model
rf_mod_many <-
    logistic_reg() %>% 
    set_engine("glm") %>%
    set_mode("classification") %>%  # note this
    step_impute_knn(all_predictors(), all_outcomes())

# specify workflow
rf_wf_many <-
    workflow() %>%
    add_model(rf_mod_many) %>% 
    add_recipe(my_rec)
```

## 4: fit model

```{r}
tree_res <- fit(rf_wf_many, data = data_train)

predict(tree_res, data_test)

final_fit <- last_fit(tree_res, train_test_split,
               metrics = metric_set(roc_auc, accuracy, kap, 
                                                    sensitivity, specificity, precision))
```

### Try it out!

```{r}

```

### What do you notice?

- 

## 5: evaluate

```{r}
# fit stats
final_fit %>%
    collect_metrics()

# variable importance plot
final_fit %>% 
    pluck(".workflow", 1) %>%   
    extract_fit_parsnip() %>% 
    vip(num_features = 10)

final_fit$.predictions[[1]] %>% 
    select(.pred_class, code) %>% 
    count(.pred_class, code)

final_fit$.predictions[[1]] %>% 
    conf_mat(.pred_class, code)

ff <- final_fit$.predictions[[1]]

dddd <-ddd %>% 
    mutate(.row = row_number()) %>% 
    select(.row, id_string)

ff %>% 
    left_join(dddd) %>% 
    mutate(id_string = as.integer(id_string)) %>% 
    arrange(id_string)
```

https://jmichaelrosenberg.shinyapps.io/ngsschat-shiny/?_ga=2.38519205.702775292.1654809427-1030483970.1645622648